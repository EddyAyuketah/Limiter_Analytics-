import React, { useEffect } from "react";
import { Routes, Route } from "react-router-dom";
import { IntelHeader, MultiPageApp, MultiPageAppProps } from "@intc/ReportBuilder";
import "@intc/dlux-bootstrap/dist/css/dlux.css";
import "bootstrap/dist/js/bootstrap.bundle.js";
import "react-bootstrap-typeahead/css/Typeahead.css";
import "tabulator-tables/dist/css/tabulator.min.css";
import "@intc/ReportBuilder/dist/ReportBuilderStandard.css";

function formatLimiterConfig() {
  return {
    defaultPage: "LimiterDashboard",
    pages: {
      LimiterDashboard: {
        pageConfig: {
          pageName: "Limiter Analysis",
          datasets: {
            LIMITER_DATA: {
              type: "jsonFile",
              url: "data/sample_data.json", // Updated path for public folder access
              // Added caching and refresh options
              cacheTime: 300000, // Cache for 5 minutes
              refreshInterval: 0, // No automatic refresh
              errorHandler: (error) => {
                console.error("Error loading data:", error);
                return { error: true, message: "Failed to load data file" };
              }
            }
          },
          visuals: {
            // 1. Limiter Table - Improved configuration
            limiterTable: {
              dataset: "LIMITER_DATA",
              visualName: "limiterTable",
              type: "IntelTabulator",
              position: {
                position: "absolute",
                top: "0%",
                left: "0%",
                width: "100%",
                height: "35%"
              },
              component: {
                columns: [
                  { 
                    field: "CEID", 
                    title: "CEID", 
                    width: 70,
                    headerFilter: true 
                  },
                  { 
                    field: "AREA", 
                    title: "Area", 
                    width: 80,
                    headerFilter: true 
                  },
                  { 
                    field: "ABA_PERCENT_FLAGED_3DAYS", 
                    title: "3d", 
                    formatter: "progress", 
                    formatterParams: { 
                      min: 0, 
                      max: 1,
                      legend: true,
                      legendColor: "#000000",
                      legendAlign: "center",
                      legendFormatter: function(v) { return (v * 100).toFixed(1) + "%" }
                    } 
                  },
                  { 
                    field: "ABA_PERCENT_FLAGED_7DAYS", 
                    title: "7d", 
                    formatter: "progress", 
                    formatterParams: { 
                      min: 0, 
                      max: 1,
                      legend: true,
                      legendColor: "#000000",
                      legendAlign: "center",
                      legendFormatter: function(v) { return (v * 100).toFixed(1) + "%" }
                    }
                  },
                  { 
                    field: "ABA_PERCENT_FLAGED_14DAYS", 
                    title: "14d", 
                    formatter: "progress", 
                    formatterParams: { 
                      min: 0, 
                      max: 1,
                      legend: true,
                      legendColor: "#000000",
                      legendAlign: "center",
                      legendFormatter: function(v) { return (v * 100).toFixed(1) + "%" }
                    }
                  },
                  { 
                    field: "ABA_PERCENT_FLAGED_28DAYS", 
                    title: "28d", 
                    formatter: "progress", 
                    formatterParams: { 
                      min: 0, 
                      max: 1,
                      legend: true,
                      legendColor: "#000000",
                      legendAlign: "center",
                      legendFormatter: function(v) { return (v * 100).toFixed(1) + "%" }
                    }
                  }
                ],
                layout: "fitColumns",
                responsiveLayout: "collapse",
                placeholder: "No Data Available",
                pagination: "local",
                paginationSize: 15,
                movableColumns: true,
                resizableRows: true,
                initialSort: [
                  { column: "ABA_PERCENT_FLAGED_28DAYS", dir: "desc" }
                ],
                selectable: true
              }
            },

            // 2. Limiter Trend Comparison - Fixed and improved
            limitationTrendChart: {
              dataset: "LIMITER_DATA",
              visualName: "limitationTrendChart",
              type: "IntelECharts",
              position: {
                position: "absolute",
                top: "36%",
                left: "0%",
                width: "50%",
                height: "30%"
              },
              component: {
                chartType: "line",
                xAxisField: "CEID",
                yAxisType: "value",
                yAxisName: "Limitation %",
                axisPointer: { type: 'cross' },
                grid: { containLabel: true },
                series: [
                  { 
                    dataField: "ABA_PERCENT_FLAGED_3DAYS", 
                    name: "3 Days", 
                    type: "line",
                    symbolSize: 6,
                    lineStyle: { width: 2 },
                    emphasis: { focus: 'series' }
                  },
                  { 
                    dataField: "ABA_PERCENT_FLAGED_7DAYS", 
                    name: "7 Days", 
                    type: "line",
                    symbolSize: 6,
                    lineStyle: { width: 2 },
                    emphasis: { focus: 'series' }
                  },
                  { 
                    dataField: "ABA_PERCENT_FLAGED_14DAYS", 
                    name: "14 Days", 
                    type: "line",
                    symbolSize: 6,
                    lineStyle: { width: 2 },
                    emphasis: { focus: 'series' }
                  },
                  { 
                    dataField: "ABA_PERCENT_FLAGED_28DAYS", 
                    name: "28 Days", 
                    type: "line",
                    symbolSize: 6,
                    lineStyle: { width: 2 },
                    emphasis: { focus: 'series' }
                  }
                ],
                tooltip: {
                  trigger: 'axis',
                  formatter: function(params) {
                    let result = params[0].name + '<br/>';
                    params.forEach(param => {
                      result += param.seriesName + ': ' + (param.value * 100).toFixed(1) + '%<br/>';
                    });
                    return result;
                  }
                }
              }
            },

            // 3. Heatmap with custom thresholds - Fixed configuration
            heatmapArea: {
              dataset: "LIMITER_DATA",
              visualName: "heatmapArea",
              type: "IntelHeatmap",
              position: {
                position: "absolute",
                top: "36%",
                left: "50%",
                width: "50%",
                height: "30%"
              },
              component: {
                xField: "AREA",
                yFields: [
                  "ABA_PERCENT_FLAGED_3DAYS",
                  "ABA_PERCENT_FLAGED_7DAYS",
                  "ABA_PERCENT_FLAGED_14DAYS",
                  "ABA_PERCENT_FLAGED_28DAYS"
                ],
                yLabels: ["3d", "7d", "14d", "28d"],
                colorFormatter: function(value) {
                  if (value <= 0.5) return "#22c55e";
                  if (value <= 0.7) return "#facc15";
                  return "#ef4444";
                },
                tooltipFormatter: function(x, y, value) {
                  return x + " - " + y + ": " + (value * 100).toFixed(1) + "%";
                }
              }
            },

            // 4. Forecast chart - Fixed configuration
            forecastChart: {
              dataset: "LIMITER_DATA",
              visualName: "forecastChart",
              type: "IntelECharts",
              position: {
                position: "absolute",
                top: "67%",
                left: "0%",
                width: "100%",
                height: "22%"
              },
              component: {
                chartType: "line",
                xAxisField: "CEID",
                yAxisType: "value",
                yAxisName: "Limitation %",
                series: [
                  {
                    dataField: "ABA_PERCENT_FLAGED_28DAYS",
                    name: "Current Value",
                    type: "line",
                    symbolSize: 8,
                    lineStyle: { width: 2 }
                  },
                  {
                    dataField: "ABA_PERCENT_FLAGED_28DAYS",
                    name: "Forecast (EMA)",
                    type: "line",
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 6,
                    lineStyle: { 
                      width: 2,
                      type: 'dashed' 
                    },
                    itemStyle: { color: '#ff7300' },
                    areaStyle: {
                      color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                          { offset: 0, color: 'rgba(255,115,0,0.3)' },
                          { offset: 1, color: 'rgba(255,115,0,0)' }
                        ]
                      }
                    },
                    // Apply EMA algorithm
                    encode: {
                      x: "CEID",
                      y: function(data) {
                        // Simple EMA implementation
                        const alpha = 0.5;
                        const values = data.map(item => item.ABA_PERCENT_FLAGED_28DAYS);
                        const ema = [values[0]];
                        
                        for (let i = 1; i < values.length; i++) {
                          ema.push(alpha * values[i] + (1 - alpha) * ema[i-1]);
                        }
                        
                        // Extend forecast for 3 more periods
                        for (let i = 0; i < 3; i++) {
                          ema.push(ema[ema.length - 1]);
                        }
                        
                        return ema;
                      }
                    }
                  }
                ],
                tooltip: {
                  trigger: 'axis',
                  formatter: function(params) {
                    let result = params[0].name + '<br/>';
                    params.forEach(param => {
                      result += param.seriesName + ': ' + (param.value * 100).toFixed(1) + '%<br/>';
                    });
                    return result;
                  }
                }
              }
            },

            // 5. Alerts Component - Reactive alerts
            alertsText: {
              visualName: "alertsText",
              type: "RichTextBox",
              position: {
                position: "absolute",
                top: "90%",
                left: "0%",
                width: "100%",
                height: "10%"
              },
              component: {
                text: `
                  <div style="font-weight:bold;color:#ef4444">Critical Alerts:</div>
                  <ul>
                    <li><strong>CVD01</strong> exceeds 80% on 28d</li>
                    <li><strong>CVD03</strong> trending toward red zone</li>
                  </ul>
                `,
                // Added dataListener to update alerts dynamically
                dataListener: {
                  dataset: "LIMITER_DATA",
                  handler: function(data) {
                    if (!data || !data.length) return;
                    
                    const criticalAlerts = data.filter(item => 
                      item.ABA_PERCENT_FLAGED_28DAYS > 0.8
                    ).map(item => 
                      `<li><strong>${item.CEID}</strong> exceeds 80% on 28d</li>`
                    );
                    
                    const warningAlerts = data.filter(item => 
                      item.ABA_PERCENT_FLAGED_28DAYS > 0.6 && 
                      item.ABA_PERCENT_FLAGED_28DAYS <= 0.8 &&
                      item.ABA_PERCENT_FLAGED_14DAYS < item.ABA_PERCENT_FLAGED_28DAYS
                    ).map(item => 
                      `<li><strong>${item.CEID}</strong> trending toward red zone</li>`
                    );
                    
                    return `
                      <div style="font-weight:bold;color:#ef4444">Critical Alerts:</div>
                      <ul>
                        ${criticalAlerts.join('')}
                      </ul>
                      <div style="font-weight:bold;color:#facc15">Warning Alerts:</div>
                      <ul>
                        ${warningAlerts.join('')}
                      </ul>
                    `;
                  }
                }
              }
            }
          },

          clickers: [
            {
              type: "clicker",
              visualName: "ceid_clicker",
              component: {
                type: "dropdown",
                multiSelect: true,
                dataset: "LIMITER_DATA",
                datasetColumn: "CEID",
                displayText: "Filter CEIDs",
                linkedDatasets: [{ dataset: "LIMITER_DATA", column: "CEID" }],
                // Added selectFirst option to improve usability
                selectFirst: false,
                showSelectAll: true
              }
            },
            {
              type: "clicker",
              visualName: "area_clicker",
              component: {
                type: "dropdown",
                multiSelect: true,
                dataset: "LIMITER_DATA",
                datasetColumn: "AREA",
                displayText: "Filter Areas",
                linkedDatasets: [{ dataset: "LIMITER_DATA", column: "AREA" }],
                // Added selectFirst option to improve usability
                selectFirst: false,
                showSelectAll: true
              }
            }
          ]
        },
        pageOrder: 1
      }
    }
  };
}

const headerConfig = {
  visualName: "header",
  position: {
    position: "absolute",
    top: "0%",
    left: "0%",
    width: "100%",
    height: "50px"
  },
  type: "header",
  component: {
    iconName: "LogoClassicBlueFull",
    reportName: "Limiter Analysis Dashboard",
    // Added helpful navigation links
    navLinks: [
      { text: "Dashboard", link: "/" },
      { text: "Documentation", link: "/docs", external: true }
    ]
  }
};

function App() {
  const config = formatLimiterConfig();
  
  // Added error handling and data file verification
  useEffect(() => {
    // Add global error handler
    window.addEventListener('error', (event) => {
      console.error('Application error:', event.error);
      // You could add error reporting here
    });
    
    // Verify data file exists
    fetch('data/sample_data.json')
      .then(response => {
        if (!response.ok) {
          console.error('Data file not found or not accessible');
          alert('Warning: Could not load data file. Please check that sample_data.json exists in the public/data folder.');
        }
      })
      .catch(error => {
        console.error('Error checking data file:', error);
      });
    
    return () => {
      window.removeEventListener('error', () => {});
    };
  }, []);

  return (
    <>
      <IntelHeader visualRow={headerConfig} />
      <Routes>
        <Route path="/" element={
          <MultiPageApp 
            pageConfig={config} 
            errorFallback={(error) => (
              <div className="alert alert-danger m-3">
                <h4>Application Error</h4>
                <p>There was an error loading the dashboard. Please try refreshing the page.</p>
                <details>
                  <summary>Error details</summary>
                  <pre>{error.message}</pre>
                </details>
              </div>
            )}
          />
        } />
        <Route path="/*" element={
          <div className="alert alert-warning m-5">
            <h4>Page Not Found</h4>
            <p>The requested page could not be found.</p>
            <a href="/" className="btn btn-primary">Return to Dashboard</a>
          </div>
        } />
      </Routes>
    </>
  );
}

export default App;
